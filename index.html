<!DOCTYPE html>
<html>
    <head>
        <title>HW2</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
    </head>
    <body>
        <div id="svg-container" style="display:block; width: 500px; margin: auto;">
            <svg id="court" width="470px" height="500px" style="transform: rotate(270deg);">
                <g fill="none">
                    <!--  court outline & background -->
                    <image id="wood-floor" x="0" y="0" width="500" xlink:href="images/wood-floor-pattern.jpeg" style="opacity: 0.7; transform: rotate(90deg) translate(0, -100%);"></image>
                    <!-- image from iStock by Getty Images (https://www.istockphoto.com/photos/light-wood-floor-texture) -->
                    <rect width="100%" height="100%" fill="none" stroke="#116cb6" stroke-width="2" />
                
                    <!-- half court logo and circle -->
                    <image href="images/knicks-logo.svg" x="73.25%" y="19%" height="250" width="250"/>
                    <!-- image from Wikipedia (https://en.wikipedia.org/wiki/New_York_Knicks) -->

                    <circle cx="100%" cy="50%" r="12%" fill="none" stroke="#fff" stroke-width="1.5" />
                
                    <!-- 3-point arc -->
                    <line x1="0%" y1="6%" x2="29.79%" y2="6%" stroke="#116cb6" stroke-width="1.3" />
                    <line x1="0%" y1="94%" x2="29.79%" y2="94%" stroke="#116cb6" stroke-width="1.3" />  
                    <path d="M 138.97 470.2 A 237.5 237.5 0 0 0 138.97 29.79" fill="none" stroke="#116cb6" stroke-width="1.4" />
                
                    <!-- shaded area -->
                    <rect y="170" width="190" height="160" fill="#116cb6" stroke="#fff" stroke-width="1" />
                
                    <!-- board and rim -->
                    <line x1="40" y1="220" x2="40" y2="280" stroke="#b37336" stroke-width="1" />
                    <circle cx="55" cy="250" r="15" fill="none" stroke="#b37336" stroke-width="1" />    
                
                    <!-- free throw circle -->
                    <path d="M 190 190 A 60 60 0 0 0 190 310" fill="none" stroke="#fff" stroke-width="1" stroke-dasharray="10,10" />
                    <path d="M 190 310 A 60 60 0 0 0 190 190" fill="none" stroke="#116cb6" stroke-width="1.5" />
                
                    <!-- shaded area -->
                    <rect x="750" y="170" width="190" height="160" fill="#116cb6" stroke="#fff" stroke-width="1" />
                
                    <!-- restricted area -->
                    <path d="M 55 290 A 40 40 0 0 0 55 210" fill="none" stroke="#fff" stroke-width="1" />
                </g>
            </svg>
            <div>
                <text id="FG"></text>
                <text id="FG3"></text>
            </div>

            <div id="mouseover-data">
                <text id="player"></text>
            </dvi>

            
        </div>

        <script>
            const load = async function() {
                let data = await d3.csv("nba_shotchartdetail_2018-19.csv");
                data = data.filter((d) => { return (d["TEAM_NAME"]==="New York Knicks")});

                let datesDict = {}
                let players = []

                data.forEach(d => {
                    d["GAME_DATE"] = d["GAME_DATE"].slice(4,6) + "-" + d["GAME_DATE"].slice(6,8) + "-" + d["GAME_DATE"].slice(0,4);
                    d["LOC_X"] = Number(d["LOC_X"])
                    d["LOC_Y"] = Math.min(Number(d["LOC_Y"]), 425) //push outliers from beyond halfcourt to halfcourt line
                    d["GAME_EVENT_ID"] = Number(d["GAME_EVENT_ID"])
                    d["GAME_ID"] = Number(d["GAME_ID"])
                    d["MINUTES_REMAINING"] = Number(d["MINUTES_REMAINING"])
                    d["SECONDS_REMAINING"] = Number(d["SECONDS_REMAINING"])
                    d["SHOT_ATTEMPTED_FLAG"] = Number(d["SHOT_ATTEMPTED_FLAG"])
                    d["SHOT_MADE_FLAG"] = Number(d["SHOT_MADE_FLAG"])
                    d["PERIOD"] = Number(d["PERIOD"])
                    d["SHOT_DISTANCE"] = Number(d["SHOT_DISTANCE"])
                    d["TEAM_ID"] = Number(d["TEAM_ID"])

                    if (!(Object.keys(datesDict).includes(d['GAME_DATE']))){
                        if (d['HTM']=="NYK"){
                            datesDict[d['GAME_DATE']] = "(vs. " + d['VTM']
                        } else {
                            datesDict[d['GAME_DATE']] = "(at " + d['HTM']
                        }
                    }

                    if (!players.includes(d['PLAYER_NAME'])) {
                        players.push(d['PLAYER_NAME']);
                    }

                    
                });

                console.log(data);

                const court = d3.select("svg#court");
                const width = court.attr("width");
                const height = court.attr("height");

                const xExtent = d3.extent(data, d => d['LOC_X']);
                const yExtent = d3.extent(data, d => d['LOC_Y']);

                const xScale = d3.scaleLinear().domain(xExtent).range([0, height]);
                const yScale = d3.scaleLinear().domain(yExtent).range([0, width]);
                const shotMadeScale = d3.scaleOrdinal().domain([0,1]).range(['red', 'green'])

                // court.selectAll("circle")
                //     .data(data).enter()
                //     .append("circle")
                //     .attr("cy", d => xScale(d["LOC_X"]))
		        //     .attr("cx", d => yScale(d["LOC_Y"]))
                //     .attr("r", 2)
                //     .attr("stroke", d => shotMadeScale(d['SHOT_MADE_FLAG']) )
                //     .attr("stroke-width", "2px")
                //     .attr("fill", "none")
                //     .attr("opacity", .5)


                let mouseoverSVG = d3.select("#mouseover-data")
                   
                // let playerText = mouseoverSVG.append("text")
                //         .attr("id", "player")

                console.log(mouseoverSVG)

                var select = d3.select("body")
                                .append("div")
                                .append("select")
                                .attr("id", "gameSelect")

                select.selectAll("option")
                        .data(Object.keys(datesDict))
                        .enter()
                            .append("option")
                            .attr("value", function (d) { return d; })
                            .text(function (d) { return d + " " + datesDict[d] + ")"; });
                
                select
                    .on("change", function(d) {
                        // console.log(d.target);
                        filter();
                    });

                let tooltipWidth = 120;
                let tooltipHeight = 40;
            
                let tooltip = court.append("g")
                                .attr("class","tooltip")
                                .attr("visibility","hidden");
                tooltip.append("rect")
                    .attr("fill", "black")
                    .attr("opacity", 0.9)
                    .attr("x", -tooltipWidth / 2.0)
                    .attr("y", 0)
                    .attr("width",tooltipWidth)
                    .attr("height",tooltipHeight)
                let txt = tooltip.append("text")
                                .attr("fill", "white")
                                .attr("text-anchor","middle")
                                .attr("alignment-baseline","hanging")
                                .attr("x", 0)
                                .attr("y", 2);
                let txt2 = tooltip.append("text")
                                .attr("fill", "white")
                                .attr("text-anchor","middle")
                                .attr("alignment-baseline","hanging")
                                .attr("x", 0)
                                .attr("y", 22);
                
            
                function mouseEntersPlot(e, d) {
                    tooltip.style("visibility","visible")
                    // console.log(d)
                
                    let shot = d3.select(this);
                   
                    txt.text(d['PLAYER_NAME']);
                    txt2.text("Q" + d['PERIOD'] + " " + d['MINUTES_REMAINING'] + ":" + d['SECONDS_REMAINING']);
                
                    let xPos = (xScale((d['LOC_X'])));
                    let yPos = (yScale(d['LOC_Y']+tooltipHeight));
                
                    tooltip.style("transform",`translate(${yPos}, ${xPos}) rotate(90deg)`);
                
                }
            
                function mouseLeavesPlot() {
            
                    tooltip.style("visibility","hidden");

                }

                function filter() {
                    let game = d3.select("#gameSelect").node().value;
                    let player = d3.select("#playerSelect").node().value;
                    // let gameSelect = document.getElementById("gameSelect")
                    let filteredData = data.filter((d) => { return (d["GAME_DATE"] === game && d["PLAYER_NAME"]===player)});
                    // console.log(filteredData);
                    let numMade = 0;
                    let numShot = 0;
                    let numMade3 = 0;
                    let numShot3 = 0
                    filteredData.forEach(d => {
                        numShot += 1;
                        if (d['EVENT_TYPE'] === 'Made Shot') {
                            numMade += 1;
                        }
                        if (d['SHOT_TYPE'] === '3PT Field Goal') {
                            numShot3 += 1;
                            if (d['EVENT_TYPE'] === 'Made Shot') {
                                numMade3 += 1;
                            }
                        }
                    });
                    d3.select("text#FG").text('FG: ' + numMade + '/' + numShot + ', ' + (numMade/numShot).toFixed(2) + '%');
                    d3.select("text#FG3").text('3P: ' + numMade3 + '/' + numShot3 + ', ' + (numMade3/numShot3).toFixed(2) + '%');

                    let circles = court.selectAll("circle")
                        .data(filteredData)
                        .join('circle').attr("class", "bar")
                        .on("mouseover", function(e, d){
                            d3.select("text#player").text(d['PLAYER_NAME'])
                            d3.select(this)
                                .attr("fill", shotMadeScale(d['SHOT_MADE_FLAG']))
                            mouseEntersPlot(e, d)
                        })
                        .on("mouseout", function(e, d){
                            d3.select("text#player").text("")
                            d3.selectAll("circle")
                                .attr("fill", "none")
                            mouseLeavesPlot()
                        })
                        .transition()
                        .duration(500)
                        .style("opacity", "0")
                        .transition()
                        .duration(0)
                        .attr("cy", d => xScale(d["LOC_X"]))
                        .attr("cx", d => yScale(d["LOC_Y"]))
                        .attr("r", 3)
                        .attr("stroke", d => shotMadeScale(d['SHOT_MADE_FLAG']) )
                        .attr("stroke-width", "2.5px")
                        .attr("fill", "none")
                        .transition()
                        .duration(500)
                        .style("opacity", 0.7);
                }

                var playerSelect = d3.select("body")
                                        .append("div")
                                        .append("select")
                                        .attr("id", "playerSelect")

                playerSelect.selectAll("option")
                            .data(players)
                            .enter()
                                .append("option")
                                .attr("value", function (d) { return d; })
                                .text(function (d) { return d; });

                playerSelect.on("change", function(d) {
                    filter();
                });

                filter();
            }
            load();

        </script>

    </body>
</html>
